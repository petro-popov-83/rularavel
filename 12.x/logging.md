# Логирование {#logging}

## Введение {#introduction}

Laravel предоставляет мощную систему логирования, помогающую понять, что происходит в вашем приложении. Логи можно записывать в файлы, системный журнал или отправлять в Slack для уведомления всей команды. Система основана на *каналах*: каждый канал определяет способ и место записи сообщений. Например, канал `single` пишет в один файл, а канал `slack` отправляет сообщения в Slack. За кулисами используется библиотека Monolog, что упрощает настройку различных обработчиков логов.

## Настройка {#configuration}

Параметры логирования задаются в файле конфигурации `config/logging.php`. Здесь определяется, какие каналы доступны и как они настроены. По умолчанию используется агрегирующий канал `stack`, который объединяет несколько каналов в один. Вы можете настроить:

- **Драйверы каналов** — определяют способ записи сообщений. Laravel поддерживает `custom`, `daily`, `errorlog`, `monolog`, `papertrail`, `single`, `slack`, `stack` и `syslog`. Большинство этих каналов уже описаны в конфигурационном файле.
- **Имя канала** — по умолчанию Monolog использует имя окружения (например, `production` или `local`) в качестве имени канала. Чтобы задать своё имя, добавьте опцию `name` в конфигурацию канала.
- **Параметры single и daily** — для этих каналов доступны опции `bubble`, `permission` и `locking`, а для `daily` можно задать число дней хранения файлов через переменную `LOG_DAILY_DAYS` или параметр `days`.
- **Papertrail** — требует указать `host` и `port`, полученные из Papertrail, через переменные `PAPERTRAIL_URL` и `PAPERTRAIL_PORT`.
- **Slack** — требует URL веб‑крючка Slack (`LOG_SLACK_WEBHOOK_URL`), а также позволяет задать имя пользователя, эмодзи и минимальный уровень логов (`LOG_LEVEL`). По умолчанию Slack получает сообщения уровня `critical` и выше.
- **Отслеживание устаревших функций** — чтобы логировать предупреждения о устаревших функциях PHP или Laravel, укажите канал через `LOG_DEPRECATIONS_CHANNEL` и включите трассировку стеков через `LOG_DEPRECATIONS_TRACE`. Вы также можете создать канал `deprecations` с отдельным файлом для таких сообщений.

## Создание стеков логов {#building-log-stacks}

Агрегирующий драйвер `stack` позволяет объединить несколько каналов. Например, в конфигурации можно создать канал `stack`, который пишет одновременно в `syslog` и `slack`:

```php
'channels' => [
    'stack' => [
        'driver' => 'stack',
        'channels' => ['syslog', 'slack'],
        'ignore_exceptions' => false,
    ],
    'syslog' => [
        'driver' => 'syslog',
        'level' => env('LOG_LEVEL', 'debug'),
        'facility' => env('LOG_SYSLOG_FACILITY', LOG_USER),
        'replace_placeholders' => true,
    ],
    'slack' => [
        'driver' => 'slack',
        'url' => env('LOG_SLACK_WEBHOOK_URL'),
        'username' => env('LOG_SLACK_USERNAME', 'Laravel Log'),
        'emoji' => env('LOG_SLACK_EMOJI', ':boom:'),
        'level' => env('LOG_LEVEL', 'critical'),
        'replace_placeholders' => true,
    ],
];
```

В этом примере минимальный уровень логов для `syslog` — `debug`, а для Slack — `critical`. Сообщения, записанные методом `Log::debug()`, попадут только в `syslog`, а `Log::emergency()` отправит сообщение в оба канала. Опция `ignore_exceptions` определяет, следует ли прекращать обработку других каналов при ошибке в одном из них.

## Запись сообщений {#writing-log-messages}

Для записи сообщений используйте фасад `Log` или глобальный хелпер `logger()`. Доступны уровни логов, определённые в спецификации RFC 5424, в порядке убывания важности: `emergency`, `alert`, `critical`, `error`, `warning`, `notice`, `info`, `debug`. Например:

```php
use Illuminate\Support\Facades\Log;

Log::info('Выполняется импорт пользователей');
Log::error('Ошибка при обработке заказа', ['order_id' => $orderId]);
```

Контекстные данные передаются вторым аргументом массивом и будут включены в запись. Если вы хотите добавить контекст для всех последующих сообщений в текущем канале, используйте `Log::withContext([...])`. Для общего контекста на все каналы вызовите `Log::shareContext([...])`, например для присвоения всем запросам уникального идентификатора.

### Запись в определённые каналы {#writing-to-specific-channels}

Иногда нужно отправить сообщение в канал, отличный от канала по умолчанию. В этом случае используйте метод `channel`:

```php
Log::channel('slack')->warning('На сервере мало свободного места');
```

Вы также можете создать стек каналов на лету, передав массив каналов в `stack`:

```php
Log::stack(['single', 'slack'])->info('Обновление прошло успешно');
```

Laravel позволяет создавать *одноразовые* каналы, не описанные в конфигурации. Для этого вызовите метод `Log::build()` с массивом настроек драйвера:

```php
$channel = Log::build([
    'driver' => 'single',
    'path' => storage_path('logs/custom.log'),
]);

$channel->info('Пользователь зарегистрирован');

// объединяем одноразовый канал со Slack
Log::stack(['slack', $channel])->info('Системное уведомление');
```

## Настройка Monolog {#monolog-channel-customization}

Laravel позволяет полностью контролировать конфигурацию Monolog для конкретного канала. Для этого укажите массив `tap` в конфигурации канала. Каждый элемент массива — класс с методом `__invoke`, который получает экземпляр `Illuminate\Log\Logger` и может настроить форматирование или обработчики:

```php
'single' => [
    'driver' => 'single',
    'tap' => [App\Logging\CustomizeFormatter::class],
    'path' => storage_path('logs/laravel.log'),
    'level' => env('LOG_LEVEL', 'debug'),
    'replace_placeholders' => true,
],
```

```php
namespace App\Logging;
use Illuminate\Log\Logger;
use Monolog\Formatter\LineFormatter;

class CustomizeFormatter
{
    public function __invoke(Logger $logger): void
    {
        foreach ($logger->getHandlers() as $handler) {
            $handler->setFormatter(new LineFormatter('[%datetime%] %channel%.%level_name%: %message% %context% %extra%'));
        }
    }
}
```

Классы из `tap` разрешаются через контейнер служб, поэтому в них можно использовать внедрение зависимостей.

### Создание каналов с обработчиками Monolog {#creating-monolog-handler-channels}

Если вам нужен канал, использующий специфический обработчик Monolog, которого нет среди встроенных драйверов, создайте канал с драйвером `monolog` и укажите обработчик. Также можно создать собственный драйвер, реализовав фабрику канала.

## Просмотр логов в реальном времени {#tailing-log-messages-using-pail}

Иногда необходимо наблюдать за логами в реальном времени — например, при отладке. Пакет **Laravel Pail** позволяет удобно просматривать логи любой конфигурации, включая сторонние сервисы (Sentry, Flare). Для использования установите пакет через Composer:

```bash
composer require --dev laravel/pail
```

Запуск просмотра логов выполняется командой:

```bash
php artisan pail
```

Вы можете увеличить детализацию вывода с помощью флагов `-v` и `-vv`, а также прервать просмотр комбинацией `Ctrl+C`. Пайл поддерживает фильтры:

- `--filter="QueryException"` — выводит только строки, содержащие указанный класс или текст;
- `--message="User created"` — фильтрует по тексту сообщения;
- `--level=error` — выводит сообщения определённого уровня;
- `--user=1` — показывает записи, сделанные во время авторизации пользователя с указанным ID.

Такой инструмент особенно полезен при мониторинге логов и выявлении проблем в работе приложения.
