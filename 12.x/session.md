# HTTP‑сессии {#session}

## Оглавление {#on-this-page}

- [Введение](#introduction)
- [Конфигурация](#configuration)
  - [Требования к драйверам](#driver-prerequisites)
- [Работа с сессией](#interacting-with-the-session)
  - [Получение данных](#retrieving-data)
  - [Запись данных](#storing-data)
  - [Flash‑данные](#flash-data)
  - [Удаление данных](#deleting-data)
  - [Перегенерация ID сессии](#regenerating-the-session-id)
- [Блокировка сессии](#session-blocking)
- [Создание собственных драйверов](#adding-custom-session-drivers)
  - [Реализация драйвера](#implementing-the-driver)
  - [Регистрация драйвера](#registering-the-driver)

## Введение {#introduction}

HTTP‑приложения не хранят состояние между запросами, поэтому **сессии** позволяют
сохранять информацию о пользователе между запросами. Эти данные помещаются в
устойчивое хранилище и доступны в последующих запросах. Laravel поставляется с
несколькими реализациями хранилищ сессии (файловые, cookie, базы данных,
Memcached, Redis и DynamoDB) и единым API для работы с ними. Выбор драйвера
определяется параметром `driver` в файле `config/session.php`.

### Конфигурация {#configuration}

Параметры сессии хранятся в файле `config/session.php`. По умолчанию Laravel
использует драйвер `database`. Доступны следующие драйверы:

* **file** — сессии сохраняются в каталоге `storage/framework/sessions`;
* **cookie** — данные хранятся в зашифрованных cookie;
* **database** — хранение в базе данных;
* **memcached/redis** — хранение в быстром кеше;
* **dynamodb** — хранение в AWS DynamoDB;
* **array** — данные сохраняются в PHP‑массиве и не персистируются
  (полезно для тестов).

#### Требования к драйверам {#driver-prerequisites}

- **Database**. Для драйвера `database` требуется таблица `sessions` в вашей
  базе данных. Если миграция не создана, выполните
  `php artisan make:session-table` и затем запустите `php artisan migrate`.
- **Redis**. Перед использованием Redis‑сессий установите расширение
  PhpRedis или пакет `predis/predis` и укажите переменную `SESSION_CONNECTION` в
  `.env`, чтобы выбрать соединение Redis.

## Работа с сессией {#interacting-with-the-session}

Laravel предоставляет два способа взаимодействия с сессионными данными: через
объект `Illuminate\Http\Request` и глобальный хелпер `session()`. В обоих
случаях данные читаются и записываются одинаково — различие только в стиле.

### Получение данных {#retrieving-data}

Чтобы получить данные из сессии через объект запроса, типизируйте `Request` в
подписи маршрута или метода контроллера. Для чтения значения используйте
`$request->session()->get('ключ')`. Вторым аргументом можно передать значение
по умолчанию или замыкание, которое будет выполнено, если ключ отсутствует
. Пример:

```php
use Illuminate\Http\Request;

Route::get('/profile', function (Request $request) {
    $name = $request->session()->get('name', 'Гость');
    // ...
});
```

Глобальный хелпер `session('ключ')` возвращает значение ключа, а передача
ассоциативного массива сохраняет значения в сессии.

Дополнительные методы для извлечения данных:

- `all()` — возвращает все данные из сессии.
- `only(['ключи'])` и `except(['ключи'])` — возвращают только выбранные ключи
  или исключают их.
- `has('ключ')` — проверяет наличие ключа и его значение не равно `null`.
- `exists('ключ')` — проверяет наличие ключа даже с `null` значением.
- `missing('ключ')` — возвращает `true`, если ключ отсутствует.

### Запись данных {#storing-data}

Чтобы сохранить значение, используйте `put('ключ', 'значение')` через объект
запроса или передайте массив в хелпер `session()`. Если
значение представляет собой массив, можно добавить элемент с помощью метода
`push('ключ.подключ', 'значение')`.

Для получения и одновременного удаления значения используйте `pull('ключ', 'по
умолчанию')`. Если нужно инкрементировать или
декрементировать числовое значение, примените методы `increment('ключ',
шаг)` и `decrement('ключ', шаг)`.

### Flash‑данные {#flash-data}

Иногда нужно сохранить данные только для следующего запроса (например, сообщение
о статусе). Для этого существует метод `flash('ключ', 'значение')`, который
сохраняет данные на один последующий запрос. Если
необходимо продлить срок жизни flash‑данных, используйте `reflash()` для
продления всех значений или `keep(['ключи'])` для выбора конкретных данных
. Чтобы поместить данные во flash‑сессию только на
текущий запрос, вызовите `now('ключ', 'значение')`.

### Удаление данных {#deleting-data}

Удалить конкретный элемент из сессии можно через `forget('ключ')`, удалить
несколько элементов — передав массив ключей, а полностью очистить сессию —
методом `flush()`.

### Перегенерация ID сессии {#regenerating-the-session-id}

Для защиты от атак, связанных с фиксацией сессии, полезно периодически
перегенерировать идентификатор сессии. Laravel автоматически выполняет
перегенерацию при аутентификации, однако вы можете вручную вызвать
`$request->session()->regenerate()` для генерации нового идентификатора
. Чтобы одновременно сбросить все данные,
используйте `invalidate()`.

## Блокировка сессии {#session-blocking}

По умолчанию Laravel позволяет выполнять несколько параллельных запросов,
использующих одну сессию. В редких случаях параллельные запросы могут привести
к потерям данных, если оба обращаются к одному и тому же ключу. Метод
`block` позволяет установить блокировку на время выполнения запроса, чтобы
последующие запросы ждали освобождения сессии. Укажите максимальную длительность
блокировки и время ожидания: `->block($lockSeconds, $waitSeconds)`.

## Создание собственных драйверов {#adding-custom-session-drivers}

Если стандартные драйверы не подходят, вы можете реализовать собственный
обработчик, реализующий интерфейс `SessionHandlerInterface`. В классе следует
реализовать методы `open`, `close`, `read`, `write`, `destroy` и `gc` для
работы с выбранным хранилищем (например, MongoDB).

### Регистрация драйвера {#registering-the-driver}

После реализации драйвера его нужно зарегистрировать. В методе `boot` вашего
сервис‑провайдера вызовите `Session::extend('имя', function (Application $app)
{ return new CustomSessionHandler; });`. Затем установите
`SESSION_DRIVER=имя` в `.env` или `config/session.php`, чтобы Laravel начал
использовать новый драйвер.
