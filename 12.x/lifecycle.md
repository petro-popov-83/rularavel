# Жизненный цикл запроса {#request-lifecycle}

* [Введение](#introduction)
* [Обзор жизненного цикла](#lifecycle-overview)
  * [Первые шаги](#first-steps)
  * [HTTP / консольные ядра](#http--console-kernels)
  * [Поставщики сервисов](#service-providers)
  * [Маршрутизация](#routing)
  * [Завершение](#finishing-up)
* [Фокус на поставщиках сервисов](#focus-on-service-providers)

## Введение {#introduction}

Используя любой инструмент в реальном мире, вы чувствуете себя увереннее, если понимаете, как этот инструмент работает. Разработка приложений ничем не отличается: зная, как функционируют ваши инструменты, вы чувствуете себя спокойнее и увереннее. Цель этого раздела — дать вам общее представление о том, как работает фреймворк Laravel. Знакомясь с устройством фреймворка, вы избавляетесь от ощущения «магии» и уверенно строите свои приложения. Если сейчас вы не понимаете все термины — не переживайте, со временем при чтении других разделов документации понимание придёт.

## Обзор жизненного цикла {#lifecycle-overview}

### Первые шаги {#first-steps}

Точка входа для всех запросов к приложению Laravel — файл `public/index.php`. Веб‑сервер (Apache или Nginx) перенаправляет все запросы в этот файл. Сам `index.php` содержит минимум кода: он подключает автозагрузчик Composer и получает экземпляр приложения из `bootstrap/app.php`. Первое, что делает Laravel, — создаёт экземпляр приложения и [контейнер сервисов](#service-container).

### HTTP / консольные ядра {#http--console-kernels}

Далее входящий запрос отправляется либо в HTTP‑ядро, либо в консольное ядро, в зависимости от типа запроса. Эти ядра — центральные точки, через которые проходит любой запрос. Мы сфокусируемся на HTTP‑ядре (`Illuminate\Foundation\Http\Kernel`). Оно содержит массив «загрузчиков», которые выполняются до обработки запроса: настраивают обработку ошибок, логирование, определяют окружение приложения и выполняют другие задачи. Затем HTTP‑ядро передаёт запрос через цепочку промежуточных слоёв (middleware), отвечающих за чтение и запись [HTTP‑сессии](#session), проверку режима обслуживания, [проверку CSRF‑токена](#csrf-protection) и другие действия. Метод `handle` HTTP‑ядра принимает объект запроса (`Request`) и возвращает объект ответа (`Response`), действуя как «чёрный ящик»: на вход подаётся HTTP‑запрос, на выходе получается HTTP‑ответ.

### Поставщики сервисов {#service-providers}

Одним из важнейших этапов загрузки ядра является загрузка [поставщиков сервисов](#service-providers). Поставщики сервисов отвечают за инициализацию и настройку всех компонентов фреймворка — базы данных, очередей, валидации, маршрутизации и т. д. Laravel перебирает список поставщиков и создаёт экземпляр каждого. Сначала вызывается метод `register`, затем — `boot`. Это гарантирует, что ко времени выполнения `boot` все зависимости уже зарегистрированы. Практически каждая возможность Laravel загружается поставщиком сервисов, поэтому они являются ключевым элементом процесса загрузки. Список пользовательских и сторонних поставщиков можно найти в файле `bootstrap/providers.php`. Вы можете создавать собственных поставщиков для настройки приложения.

### Маршрутизация {#routing}

После завершения инициализации приложение передаёт объект запроса маршрутизатору. Маршрутизатор сопоставляет запрос маршруту или контроллеру и выполняет назначенные этому маршруту middleware. Middleware позволяют фильтровать или анализировать HTTP‑запросы. Например, встроенный middleware проверяет, авторизован ли пользователь, и перенаправляет его на страницу входа, если нет. Некоторые middleware применяются ко всем маршрутам (например, `PreventRequestsDuringMaintenance`), а другие назначаются конкретным маршрутам или группам. После прохождения всех middleware вызывается соответствующий обработчик маршрута или метод контроллера, который возвращает ответ.

### Завершение {#finishing-up}

Возвращаемый обработчиком ответ идёт обратно по цепочке middleware, что даёт приложению возможность модифицировать или проверить исходящий ответ. Затем метод `handle` HTTP‑ядра возвращает ответ объекту приложения, который вызывает метод `send` у ответа. Метод `send` отправляет содержимое ответа в браузер пользователя. Так завершает своё путешествие через весь жизненный цикл запрос Laravel!

## Фокус на поставщиках сервисов {#focus-on-service-providers}

Поставщики сервисов действительно являются ключом к загрузке приложения Laravel. Сначала создаётся экземпляр приложения, затем регистрируются поставщики сервисов, после чего обработанный ими запрос передаётся в приложение. Ваши собственные поставщики расположены в каталоге `app/Providers`. По умолчанию `AppServiceProvider` почти пуст — это отличное место для добавления собственных привязок и начальной настройки контейнера. Для крупных приложений вы можете создать несколько поставщиков, каждый из которых отвечает за настройку определённой подсистемы.