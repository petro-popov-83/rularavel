# Обработка ошибок {#error-handling}

Laravel уже имеет настроенную обработку ошибок и исключений. При старте нового проекта вы можете не настраивать её вручную, однако при необходимости вы можете зарегистрировать собственные обработчики, используя метод `withExceptions` в файле `bootstrap/app.php`. В замыкание передаётся объект `Illuminate\Foundation\Configuration\Exceptions`, предоставляющий API для регистрации обработчиков【629346330931482†L269-L279】.

## Конфигурация {#configuration}

Вывод подробных сведений об ошибках контролируется параметром `debug` в файле `config/app.php`. Обычно значение считывается из переменной окружения `APP_DEBUG`. В процессе разработки `APP_DEBUG` следует установить в `true`, чтобы отображать трассировки и подробности, а в боевом окружении этот флаг должен быть `false`, иначе конфиденциальные данные могут стать видны пользователям【629346330931482†L281-L291】.

## Обработка исключений {#handling-exceptions}

### Логирование и отчёты {#reporting-exceptions}

Laravel записывает исключения в журнал в соответствии с настройками модуля логирования. Если требуется отправлять разные исключения в разные каналы (например, в Sentry или Flare), можно зарегистрировать колбэки с помощью метода `report` объекта `Exceptions`. Замыкание будет вызвано для указанного типа исключения, что позволяет реализовать индивидуальную логику логирования【629346330931482†L293-L332】. Для остановки передачи исключения в стандартный журнал используйте метод `stop()` или возвращайте `false` из колбэка【629346330931482†L330-L367】.

#### Глобальный контекст логов {#global-log-context}

Laravel автоматически добавляет идентификатор текущего пользователя в контекст каждого сообщения об исключении. Вы можете добавить собственные ключи в глобальный контекст, зарегистрировав функцию через метод `context` в `withExceptions`. Эта функция должна возвращать массив, который будет объединён с лог-записью【629346330931482†L373-L379】.

#### Контекст исключения {#exception-context}

Для добавления контекста только к конкретному исключению определите метод `context` в классе исключения и верните массив. Эти данные будут добавлены к записи журнала при возникновении исключения【629346330931482†L397-L444】.

#### Помощник `report` {#report-helper}

Если нужно сообщить об исключении, но продолжить выполнение запроса, используйте глобальную функцию `report($e)`. Она отправит исключение в систему логирования, но не прервёт выполнение【629346330931482†L466-L490】.

### Отрисовка исключений {#rendering-exceptions}

По умолчанию Laravel преобразует исключения в HTTP‑ответы. Вы можете зарегистрировать функцию для конкретного типа исключения через метод `render` объекта `Exceptions`. Замыкание получает экземпляры исключения и запроса, а возвращает объект `Illuminate\Http\Response`. Это позволяет, например, вернуть особое представление или JSON‑ответ для выбранного исключения【629346330931482†L721-L759】. Также можно переопределить обработку стандартных исключений (например, `NotFoundHttpException`) и вернуть JSON‑ответ для API‑маршрутов【629346330931482†L760-L802】.

Для контроля формата ответа (HTML или JSON) можно определить правило через метод `shouldRenderJsonWhen`, которое возвращает булево значение в зависимости от запроса и исключения【629346330931482†L804-L849】. При необходимости полностью переопределить ответ, используйте метод `respond` и верните свой `Response` для определённых кодов состояния, например, чтобы вернуть пользователя назад с сообщением при ошибке 419 (истекший токен)【629346330931482†L851-L895】.

#### Reportable и Renderable исключения {#reportable-renderable-exceptions}

Вместо регистрации обработчиков в `bootstrap/app.php` вы можете определить методы `report` и `render` прямо в классе собственного исключения. Метод `report` будет вызван для логирования, а метод `render` должен вернуть HTTP‑ответ【629346330931482†L897-L954】.

## Ограничение частоты отчётов {#throttling-exceptions}

При необходимости можно ограничить частоту логирования повторяющихся исключений, чтобы не засорять журнал. Для этого используется метод `throttle` объекта `Exceptions`, в который передаётся тип исключения и период (в секундах), на протяжении которого повторные исключения будут подавляться.

## HTTP‑исключения и страницы ошибок {#http-exceptions}

Иногда необходимо сгенерировать исключение с конкретным HTTP‑статусом. Для этого используется помощник `abort(404)`, который выбрасывает исключение `HttpException` и возвращает ответ с кодом 404【629346330931482†L1274-L1283】. Для вывода собственных страниц ошибок создайте Blade‑шаблоны в директории `resources/views/errors`, назвав файл по номеру кода (например, `404.blade.php`, `500.blade.php`). Эти шаблоны будут использованы вместо стандартных страниц для соответствующих кодов【629346330931482†L1285-L1293】. Можно также определить общие шаблоны `4xx.blade.php` и `5xx.blade.php` для групп кодов; однако для 404, 500 и 503 необходимо создавать отдельные файлы【629346330931482†L1309-L1318】. Для публикации стандартных шаблонов ошибок выполните `php artisan vendor:publish --tag=laravel-errors`【629346330931482†L1299-L1305】.

---

Эти средства позволяют гибко контролировать обработку и отображение ошибок в приложении. Важные ошибки должны быть задокументированы и отправлены в системы мониторинга, тогда как пользовательские ответы должны быть понятными и безопасными.