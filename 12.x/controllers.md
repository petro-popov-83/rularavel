# Контроллеры {#controllers}

- [Введение](#introduction)
- [Создание контроллеров](#writing-controllers)
  - [Базовые контроллеры](#basic-controllers)
  - [Контроллеры с единственным действием](#single-action-controllers)
  - [Промежуточные слои в контроллерах](#controller-middleware)
- [Контроллеры‑ресурсы](#resource-controllers)
  - [Частичные и API‑ресурсы](#partial-and-api-resources)
  - [Вложенные ресурсы](#nested-resources)
  - [Настройка имён и параметров](#naming-and-parameters)
  - [Синглтон‑ресурсы](#singleton-resources)
- [Внедрение зависимостей](#dependency-injection)

## Введение {#introduction}

Вместо того чтобы описывать всю логику обработки запросов в виде замыканий в
файлах маршрутов, вы можете организовать код в классах **контроллеров**.
Контроллеры группируют связанную логику в единый класс. Например,
`UserController` может отвечать за отображение, создание, обновление и удаление
пользователей. По умолчанию все контроллеры располагаются в каталоге
`app/Http/Controllers`【38098335560393†L274-L281】.

## Создание контроллеров {#writing-controllers}

### Базовые контроллеры {#basic-controllers}

Для создания контроллера воспользуйтесь Artisan‑командой `make:controller`:

```bash
php artisan make:controller UserController
```

Внутри контроллера вы можете определить любое количество публичных методов,
которые будут отвечать на входящие HTTP‑запросы. Например, метод `show`
отображает профиль пользователя:

```php
namespace App\Http\Controllers;

use App\Models\User;
use Illuminate\View\View;

class UserController extends Controller
{
    /**
     * Отобразить профиль пользователя.
     */
    public function show(string $id): View
    {
        return view('user.profile', [
            'user' => User::findOrFail($id),
        ]);
    }
}
```

После создания метода необходимо связать его с маршрутом. В файлах маршрутов
используется массив `[Controller::class, 'method']`【38098335560393†L356-L370】:

```php
use App\Http\Controllers\UserController;

Route::get('/user/{id}', [UserController::class, 'show']);
```

### Контроллеры с единственным действием {#single-action-controllers}

Если операция слишком сложна, чтобы быть методом обычного контроллера, можно
создать контроллер с одним действием. Такой контроллер имеет только метод
`__invoke`. При определении маршрута указывается только имя класса, а при
создании используется опция `--invokable`【38098335560393†L377-L446】:

```bash
php artisan make:controller ProvisionServer --invokable

// routes/web.php
use App\Http\Controllers\ProvisionServer;
Route::post('/server', ProvisionServer::class);
```

### Промежуточные слои в контроллерах {#controller-middleware}

Вы можете назначать посредники (middleware) непосредственно контроллеру. Это
делается либо в файле маршрутов методом `middleware()`, либо в самом
контроллере через реализацию интерфейса `HasMiddleware` и определение метода
`middleware`【38098335560393†L451-L503】. В методе возвращается массив строк
или объектов `Middleware`, в котором можно указывать, какие методы должны
обработать определённые посредники:

```php
use Illuminate\Routing\Controllers\HasMiddleware;
use Illuminate\Routing\Controllers\Middleware;

class UserController extends Controller implements HasMiddleware
{
    public static function middleware(): array
    {
        return [
            'auth',
            new Middleware('log', only: ['index']),
            new Middleware('subscribed', except: ['store']),
        ];
    }
}
```

## Контроллеры‑ресурсы {#resource-controllers}

Если вы рассматриваете каждую модель Eloquent как «ресурс», то часто вы
выполняете над ней типичные операции: создание, просмотр, обновление и удаление
(CRUD). Laravel позволяет автоматически создать контроллер с методами для этих
действий командой:

```bash
php artisan make:controller PhotoController --resource
```

Эта команда создаст файл `app/Http/Controllers/PhotoController.php` с
методами `index`, `create`, `store`, `show`, `edit`, `update` и `destroy`. Для
регистрации всех маршрутов достаточно одного вызова `Route::resource`【38098335560393†L581-L616】:

```php
use App\Http\Controllers\PhotoController;
Route::resource('photos', PhotoController::class);
```

Laravel также предоставляет методы `resources` и `softDeletableResources` для
регистрации нескольких ресурсов одновременно. Последний автоматически
включает обработку «мягко» удалённых моделей (soft deletes)【38098335560393†L618-L649】.

Таблица действий, обрабатываемых ресурсными контроллерами, включает семь
стандартных маршрутов, например `GET /photos` (метод `index`) и `DELETE
/photos/{photo}` (метод `destroy`)【38098335560393†L650-L659】.

К ресурсному маршруту можно добавить обработчик для случая, когда модель не
найдена. Метод `missing` принимает замыкание, которое будет вызвано, если
модель не будет найдена, и позволяет вернуть альтернативный ответ или
перенаправление【38098335560393†L661-L683】. Для работы с «мягко» удалёнными
моделями используйте метод `withTrashed`【38098335560393†L694-L717】.

#### Настройка генерации

Команда `make:controller` поддерживает опции `--model=Photo` для указания
класса модели по умолчанию и `--requests` для генерации классов запросов,
которые будут использоваться методами `store` и `update`【38098335560393†L719-L739】.

### Частичные и API‑ресурсы {#partial-and-api-resources}

Иногда необходимо сгенерировать только часть маршрутов ресурса. Метод
`only` позволяет указать список действий, которые должны быть созданы, а
`except` — исключить ненужные маршруты【38098335560393†L741-L772】:

```php
Route::resource('photos', PhotoController::class)->only([
    'index', 'show',
]);
Route::resource('photos', PhotoController::class)->except([
    'create', 'store', 'update', 'destroy',
]);
```

Для API‑маршрутов, где обычно не нужны HTML‑страницы `create` и `edit`,
используйте метод `apiResource` или `apiResources` для регистрации
одного или нескольких ресурсов【38098335560393†L774-L807】. Можно также сгенерировать API‑контроллер
с помощью опции `--api` команды `make:controller`【38098335560393†L816-L823】.

### Вложенные ресурсы {#nested-resources}

Если ресурс имеет дочерние сущности (например, фотографии и комментарии),
их можно описать вложенным ресурсом, используя точечную нотацию:

```php
Route::resource('photos.comments', PhotoCommentController::class);
```

Laravel также поддерживает «shallow» вложенность — в этом случае часть
маршрутов не требует указания идентификатора родительской модели. Метод
`shallow()` регистрирует соответствующие маршруты【38098335560393†L857-L883】.

Вы можете автоматически ограничить вложенные связывания, чтобы убедиться, что
дочерняя модель принадлежит родительской. Метод `scoped` позволяет указать,
по какому полю следует извлекать модель, например slug【38098335560393†L936-L962】.

### Настройка имён и параметров {#naming-and-parameters}

Имена маршрутов, создаваемых `Route::resource`, можно переопределить,
передав массив `names`【38098335560393†L885-L904】. Аналогично можно изменить
имя параметра, используемого в URI, с помощью метода `parameters`【38098335560393†L906-L929】:

```php
Route::resource('users', AdminUserController::class)->parameters([
    'users' => 'admin_user',
]);
```

### Синглтон‑ресурсы {#singleton-resources}

Иногда ресурс существует в единственном экземпляре (например, профиль
аутентифицированного пользователя). В таких случаях можно объявить «синглтон»
ресурс, который генерирует маршруты без параметра идентификатора. Для этого
используйте метод `Route::singleton`:

```php
Route::singleton('profile', ProfileController::class);
```

### Внедрение зависимостей {#dependency-injection}

Как и в других частях Laravel, вы можете явно указывать зависимости в
методах контроллера. Фреймворк автоматически внедрит необходимые классы из
контейнера. Это касается как сервисов (например, класс `Request`), так и
моделей, если используется привязка моделей к маршрутам. Введение зависимостей
через сигнатуры методов упрощает тестирование и улучшает читаемость кода.

Дополнительные опции, такие как локализация URI ресурсов, расширение
ресурсных контроллеров и применение middleware к ресурсам, описаны в
оригинальной документации. По мере необходимости вы можете изучить эти
разделы для более сложных сценариев.